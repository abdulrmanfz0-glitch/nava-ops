name: üõ°Ô∏è Restalyze Build Verification

on:
  push:
    branches: [ main, reporting-revolution ]
  pull_request:
    branches: [ main ]

jobs:
  verify-restalyze-architecture:
    name: Verify Restalyze Architecture
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: ‚úÖ Verify index.html is minimal
      run: |
        LINE_COUNT=$(wc -l < index.html)
        if [ $LINE_COUNT -gt 100 ]; then
          echo "‚ùå ERROR: index.html has $LINE_COUNT lines (should be < 100)"
          echo "‚ùå Possible rollback to legacy architecture detected!"
          exit 1
        fi
        echo "‚úÖ index.html is minimal ($LINE_COUNT lines)"

    - name: ‚úÖ Verify Restalyze branding
      run: |
        if ! grep -q "Restalyze" index.html; then
          echo "‚ùå ERROR: Restalyze branding not found in index.html"
          exit 1
        fi
        echo "‚úÖ Restalyze branding verified"

    - name: ‚úÖ Verify main.jsx is proper React bootstrap
      run: |
        LINE_COUNT=$(wc -l < src/main.jsx)
        if [ $LINE_COUNT -gt 50 ]; then
          echo "‚ùå ERROR: src/main.jsx has $LINE_COUNT lines (should be < 50)"
          echo "‚ùå Possible corruption detected!"
          exit 1
        fi
        echo "‚úÖ src/main.jsx is proper React bootstrap ($LINE_COUNT lines)"

    - name: ‚úÖ Verify Report Hub exists
      run: |
        if [ ! -f "src/pages/ReportHub.jsx" ]; then
          echo "‚ùå ERROR: ReportHub.jsx not found!"
          echo "‚ùå Core feature missing!"
          exit 1
        fi
        echo "‚úÖ Report Hub exists"

    - name: ‚úÖ Verify all contexts exist
      run: |
        REQUIRED_CONTEXTS=(
          "src/contexts/AuthContext.jsx"
          "src/contexts/ThemeContext.jsx"
          "src/contexts/NotificationContext.jsx"
          "src/contexts/DataContext.jsx"
        )

        for context in "${REQUIRED_CONTEXTS[@]}"; do
          if [ ! -f "$context" ]; then
            echo "‚ùå ERROR: $context not found!"
            exit 1
          fi
        done
        echo "‚úÖ All required contexts exist"

    - name: üèóÔ∏è Build verification
      run: npm run build

    - name: ‚úÖ Verify build output
      run: |
        if [ ! -d "dist" ]; then
          echo "‚ùå ERROR: Build did not create dist folder!"
          exit 1
        fi
        if [ ! -f "dist/index.html" ]; then
          echo "‚ùå ERROR: dist/index.html not found!"
          exit 1
        fi
        echo "‚úÖ Build output verified"

    - name: üìä Build summary
      run: |
        echo "üéâ All Restalyze architecture checks passed!"
        echo "‚úÖ Clean index.html"
        echo "‚úÖ Proper main.jsx"
        echo "‚úÖ Report Hub present"
        echo "‚úÖ All contexts verified"
        echo "‚úÖ Build successful"
